#!/usr/bin/env bash
# ok.lol worker daemon installer.
#
# Usage:
#   curl -fsSL https://ok.lol/install | bash
#
# Note: must be piped to bash, not sh.

set -euo pipefail

REPO="ronin-software/ok.lol"
INSTALL_DIR="$HOME/.ok.lol/bin"

# –
# Helpers
# –

status() { printf '\r\033[K%s' "$1"; }
nl()     { printf '\n'; }
die()    { nl; echo "error: $*" >&2; exit 1; }

# –
# Platform
# –

detect_platform() {
  local os arch
  os="$(uname -s)"
  arch="$(uname -m)"

  case "$os" in
    Darwin) os="darwin" ;;
    Linux)  os="linux"  ;;
    *) die "unsupported OS: $os" ;;
  esac

  case "$arch" in
    arm64 | aarch64) arch="arm64" ;;
    x86_64)          arch="x64"   ;;
    *) die "unsupported architecture: $arch" ;;
  esac

  echo "${os}-${arch}"
}

# –
# Latest release
# –

latest_tag() {
  local tag
  tag="$(
    curl -fsSL "https://api.github.com/repos/${REPO}/releases?per_page=10" \
      -H "Accept: application/vnd.github+json" \
    | grep -o '"tag_name": *"worker-v[^"]*"' \
    | head -1 \
    | cut -d'"' -f4
  )"
  [ -n "$tag" ] || die "no worker release found"
  echo "$tag"
}

# –
# Install dir
# –

# Append INSTALL_DIR to the shell profile. Prints the reload command.
add_to_path() {
  local line="export PATH=\"${INSTALL_DIR}:\$PATH\""

  case "${SHELL:-}" in
    */zsh)
      local profile="$HOME/.zshrc"
      grep -qF "$INSTALL_DIR" "$profile" 2>/dev/null || printf '\n# ok.lol\n%s\n' "$line" >> "$profile"
      echo "exec \$SHELL"
      ;;
    */bash)
      local profile
      profile="$([ -f "$HOME/.bash_profile" ] && echo "$HOME/.bash_profile" || echo "$HOME/.bashrc")"
      grep -qF "$INSTALL_DIR" "$profile" 2>/dev/null || printf '\n# ok.lol\n%s\n' "$line" >> "$profile"
      echo "source $profile"
      ;;
    */fish)
      local fish_conf="$HOME/.config/fish/conf.d"
      mkdir -p "$fish_conf"
      echo "set -gx PATH ${INSTALL_DIR} \$PATH" > "$fish_conf/ok-lol.fish"
      echo "exec \$SHELL"
      ;;
    *)
      echo "  add $INSTALL_DIR to your PATH"
      ;;
  esac
}

# –
# Main
# –

main() {
  status "resolving…"
  local platform tag
  platform="$(detect_platform)"
  tag="$(latest_tag)"

  mkdir -p "$INSTALL_DIR"

  status "downloading ${tag}…"
  curl -fsSL \
    "https://github.com/${REPO}/releases/download/${tag}/workerd-${platform}" \
    -o "$INSTALL_DIR/workerd"
  chmod +x "$INSTALL_DIR/workerd"

  nl

  # Add to PATH if needed, and print reload instruction.
  if ! echo "$PATH" | tr ':' '\n' | grep -qx "$INSTALL_DIR"; then
    local reload
    reload="$(add_to_path)"
    printf '\033[1mworkerd installed.\033[0m Reload your shell first: \033[1m%s\033[0m\n' "$reload"
    printf 'Then run: workerd <token>\n'
  else
    printf '\033[1mworkerd installed.\033[0m Run: workerd <token>\n'
  fi
}

main
